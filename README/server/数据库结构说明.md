# æ•°æ®åº“ç»“æ„è¯´æ˜

## æ•°æ®åº“è¡¨ç»“æ„

### 1. mealsï¼ˆèœå“è¡¨ï¼‰

å­˜å‚¨èœå“ä¿¡æ¯ï¼Œæ”¯æŒä¸­è‹±æ–‡åŒè¯­ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| name_zh | VARCHAR(100) | ä¸­æ–‡åç§° |
| name_en | VARCHAR(100) | è‹±æ–‡åç§°ï¼ˆå¯é€‰ï¼‰ |
| desc_zh | TEXT | ä¸­æ–‡æè¿°ï¼ˆå¯é€‰ï¼‰ |
| desc_en | TEXT | è‹±æ–‡æè¿°ï¼ˆå¯é€‰ï¼‰ |
| price | DECIMAL(10,2) | ä»·æ ¼ |
| category | VARCHAR(50) | åˆ†ç±»ï¼ˆå¦‚ï¼šä¸»é£Ÿå¥—é¤ã€å°é£Ÿã€é¥®å“ç­‰ï¼‰ |
| image_url | VARCHAR(500) | å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰ |
| icon | VARCHAR(10) | å›¾æ ‡ï¼ˆemojiï¼Œå¯é€‰ï¼‰ |
| is_active | BOOLEAN | æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤ï¼štrueï¼‰ |
| sort_order | INTEGER | æ’åºé¡ºåºï¼ˆé»˜è®¤ï¼š0ï¼‰ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_meals_category`: category
- `idx_meals_is_active`: is_active
- `idx_meals_sort_order`: sort_order

### 2. ordersï¼ˆè®¢å•è¡¨ï¼‰

å­˜å‚¨è®¢å•ä¸»ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| order_number | VARCHAR(50) | è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰ |
| store_id | INTEGER | åº—é“ºIDï¼ˆä¸ºå¤šåº—é“ºåŠŸèƒ½é¢„ç•™ï¼Œé»˜è®¤ï¼š1ï¼‰ |
| total_amount | DECIMAL(10,2) | è®¢å•æ€»é‡‘é¢ |
| order_type | INTEGER | è®¢å•ç±»å‹ï¼š0=å ‚é£Ÿ, 1=å¤–å–ï¼ˆé»˜è®¤ï¼š0ï¼‰ |
| payment_method_id | INTEGER | ä»˜æ¬¾æ–¹å¼IDï¼ˆå¤–é”®ï¼Œå…³è” payment_methods.idï¼‰ |
| status | VARCHAR(20) | è®¢å•çŠ¶æ€ï¼špending(å¾…æ”¯ä»˜), paid(å·²æ”¯ä»˜), completed(å·²å®Œæˆ), cancelled(å·²å–æ¶ˆ) |
| print_status | VARCHAR(20) | æ‰“å°çŠ¶æ€ï¼šsuccess, error, null |
| print_message | TEXT | æ‰“å°æ¶ˆæ¯ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_orders_order_number`: order_numberï¼ˆå”¯ä¸€ï¼‰
- `idx_orders_store_id`: store_id
- `idx_orders_status`: status
- `idx_orders_order_type`: order_type
- `idx_orders_payment_method_id`: payment_method_id
- `idx_orders_created_at`: created_at
- `idx_orders_store_created`: (store_id, created_at) å¤åˆç´¢å¼•

**å¤–é”®å…³ç³»ï¼š**
- `payment_method_id` â†’ `payment_methods.id` (SET NULL åˆ é™¤ï¼Œå…è®¸è®¢å•ä¿ç•™å†å²ä»˜æ¬¾æ–¹å¼ä¿¡æ¯)

### 3. order_itemsï¼ˆè®¢å•æ˜ç»†è¡¨ï¼‰

å­˜å‚¨è®¢å•ä¸­çš„æ¯ä¸ªå•†å“æ˜ç»†ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| order_id | INTEGER | è®¢å•IDï¼ˆå¤–é”®ï¼Œå…³è” orders.idï¼‰ |
| meal_id | INTEGER | èœå“IDï¼ˆå¤–é”®ï¼Œå…³è” meals.idï¼‰ |
| quantity | INTEGER | æ•°é‡ |
| price | DECIMAL(10,2) | å•ä»·ï¼ˆä¸‹å•æ—¶çš„ä»·æ ¼ï¼Œé˜²æ­¢ä»·æ ¼å˜åŠ¨å½±å“å†å²è®¢å•ï¼‰ |
| subtotal | DECIMAL(10,2) | å°è®¡ï¼ˆquantity * priceï¼‰ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_order_items_order_id`: order_id
- `idx_order_items_meal_id`: meal_id
- `idx_order_items_order_meal`: (order_id, meal_id) å¤åˆç´¢å¼•

**å¤–é”®å…³ç³»ï¼š**
- `order_id` â†’ `orders.id` (CASCADE åˆ é™¤)
- `meal_id` â†’ `meals.id` (RESTRICT åˆ é™¤ï¼Œé˜²æ­¢åˆ é™¤æœ‰è®¢å•çš„èœå“)

### 4. settingsï¼ˆç³»ç»Ÿè®¾ç½®è¡¨ï¼‰

å­˜å‚¨åº—é“ºé…ç½®å’Œç³»ç»Ÿè®¾ç½®ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| key | VARCHAR(100) | è®¾ç½®é”®åï¼ˆå”¯ä¸€ï¼‰ |
| value | TEXT | è®¾ç½®å€¼ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ |
| description | VARCHAR(500) | è®¾ç½®æè¿° |
| category | VARCHAR(50) | è®¾ç½®åˆ†ç±»ï¼šstore(åº—é“ºä¿¡æ¯), sync(äº‘ç«¯åŒæ­¥), system(ç³»ç»Ÿè®¾ç½®) |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_settings_key`: keyï¼ˆå”¯ä¸€ï¼‰
- `idx_settings_category`: category

**é»˜è®¤è®¾ç½®é¡¹ï¼š**
- `store_id`: åº—é“ºIDï¼ˆé»˜è®¤ï¼š1ï¼‰
- `store_name`: åº—é“ºåç§°ï¼ˆé»˜è®¤ï¼š'é»˜è®¤åº—é“º'ï¼‰
- `store_address`: åº—é“ºåœ°å€
- `store_phone`: åº—é“ºç”µè¯
- `sync_enabled`: æ˜¯å¦å¯ç”¨äº‘ç«¯åŒæ­¥ï¼ˆé»˜è®¤ï¼šfalseï¼‰
- `sync_url`: äº‘ç«¯åŒæ­¥APIåœ°å€
- `sync_interval`: åŒæ­¥é—´éš”ï¼ˆåˆ†é’Ÿï¼Œé»˜è®¤ï¼š60ï¼‰
- `sync_api_key`: äº‘ç«¯åŒæ­¥APIå¯†é’¥
- `last_sync_time`: æœ€ååŒæ­¥æ—¶é—´

### 5. payment_methodsï¼ˆä»˜æ¬¾æ–¹å¼è¡¨ï¼‰

å­˜å‚¨ä»˜æ¬¾æ–¹å¼ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| code | VARCHAR(50) | ä»˜æ¬¾æ–¹å¼ä»£ç ï¼ˆå”¯ä¸€ï¼Œå¦‚ï¼šwechat, alipay, visa, octopusï¼‰ |
| name_zh | VARCHAR(100) | ä¸­æ–‡åç§° |
| name_en | VARCHAR(100) | è‹±æ–‡åç§°ï¼ˆå¯é€‰ï¼‰ |
| icon | VARCHAR(50) | å›¾æ ‡ï¼ˆemoji æˆ–å›¾æ ‡ç±»åï¼Œå¯é€‰ï¼‰ |
| is_active | BOOLEAN | æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤ï¼štrueï¼‰ |
| sort_order | INTEGER | æ’åºé¡ºåºï¼ˆé»˜è®¤ï¼š0ï¼‰ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_payment_methods_code`: codeï¼ˆå”¯ä¸€ï¼‰
- `idx_payment_methods_is_active`: is_active
- `idx_payment_methods_sort_order`: sort_order

**é»˜è®¤ä»˜æ¬¾æ–¹å¼ï¼š**
- å¾®ä¿¡æ”¯ä»˜ï¼ˆwechatï¼‰
- æ”¯ä»˜å®ï¼ˆalipayï¼‰
- Visa
- Mastercard
- å…«è¾¾é€šï¼ˆoctopusï¼‰
- ç°é‡‘ï¼ˆcashï¼‰

## æ•°æ®åˆå§‹åŒ–

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼š
- **é»˜è®¤èœå“æ•°æ®**ï¼š
  - ä¸€èœå¥—é¤ï¼ˆÂ¥15.00ï¼‰
  - ä¸¤èœå¥—é¤ï¼ˆÂ¥25.00ï¼‰
- **é»˜è®¤ä»˜æ¬¾æ–¹å¼**ï¼š
  - å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€Visaã€Mastercardã€å…«è¾¾é€šã€ç°é‡‘

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–é»˜è®¤èœå“æ•°æ®ï¼š
- ä¸€èœå¥—é¤ï¼ˆÂ¥15.00ï¼‰
- ä¸¤èœå¥—é¤ï¼ˆÂ¥25.00ï¼‰

å¦‚éœ€æ·»åŠ æ›´å¤šèœå“ï¼Œå¯ä»¥é€šè¿‡æ•°æ®åº“ç®¡ç†å·¥å…·æˆ– API æ·»åŠ ã€‚

## æ•°æ®åº“è¿ç§»

### ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœä¹‹å‰ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„æ•°æ®åº“ç»“æ„ï¼ˆåªæœ‰ orders è¡¨ï¼‰ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **å¤‡ä»½æ—§æ•°æ®**ï¼ˆå¦‚æœæœ‰é‡è¦æ•°æ®ï¼‰ï¼š
   ```sql
   -- å¯¼å‡ºæ—§è®¢å•æ•°æ®ï¼ˆå¦‚æœéœ€è¦ä¿ç•™ï¼‰
   .mode csv
   .output old_orders.csv
   SELECT * FROM orders;
   ```

2. **åˆ é™¤æ—§è¡¨**ï¼š
   ```sql
   DROP TABLE IF EXISTS orders;
   ```

3. **é‡æ–°å¯åŠ¨æœåŠ¡å™¨**ï¼š
   æœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„è¡¨ç»“æ„å¹¶åˆå§‹åŒ–é»˜è®¤æ•°æ®ã€‚

### æ‰‹åŠ¨åˆå§‹åŒ–èœå“æ•°æ®

å¦‚æœéœ€è¦æ‰‹åŠ¨æ·»åŠ èœå“ï¼Œå¯ä»¥ä½¿ç”¨ SQLï¼š

```sql
INSERT INTO meals (name_zh, name_en, desc_zh, desc_en, price, category, icon, is_active, sort_order)
VALUES 
  ('ä¸€èœå¥—é¤', 'One Dish Combo', 'ç²¾é€‰ä¸€èœ', 'Selected One Dish', 15.00, 'ä¸»é£Ÿå¥—é¤', 'ğŸ±', 1, 1),
  ('ä¸¤èœå¥—é¤', 'Two Dish Combo', 'ç²¾é€‰ä¸¤èœ', 'Selected Two Dishes', 25.00, 'ä¸»é£Ÿå¥—é¤', 'ğŸ²', 1, 2);
```

## åç»­åŠŸèƒ½æ”¯æŒ

å½“å‰æ•°æ®åº“ç»“æ„å·²ä¸ºä»¥ä¸‹åŠŸèƒ½é¢„ç•™äº†æ”¯æŒï¼š

1. **å¤šåº—é“ºç®¡ç†**ï¼š`orders.store_id` å­—æ®µ + `settings` è¡¨å­˜å‚¨åº—é“ºä¿¡æ¯
2. **è®¢å•çŠ¶æ€è·Ÿè¸ª**ï¼š`orders.status` å­—æ®µ
3. **è®¢å•ç±»å‹åŒºåˆ†**ï¼š`orders.order_type` å­—æ®µï¼ˆ0=å ‚é£Ÿ, 1=å¤–å–ï¼‰
4. **ä»˜æ¬¾æ–¹å¼ç®¡ç†**ï¼š`payment_methods` è¡¨ + `orders.payment_method_id` å­—æ®µ
5. **èœå“åˆ†ç±»**ï¼š`meals.category` å­—æ®µ
6. **èœå“ä¸Šä¸‹æ¶**ï¼š`meals.is_active` å­—æ®µ
7. **äº‘ç«¯åŒæ­¥**ï¼š`settings` è¡¨å­˜å‚¨åŒæ­¥é…ç½®
   - `sync_enabled`: æ˜¯å¦å¯ç”¨åŒæ­¥
   - `sync_url`: äº‘ç«¯APIåœ°å€
   - `sync_interval`: åŒæ­¥é—´éš”
   - `sync_api_key`: APIå¯†é’¥
   - `last_sync_time`: æœ€ååŒæ­¥æ—¶é—´
8. **æŠ¥å‘Šç»Ÿè®¡**ï¼š
   - è®¢å•æ—¶é—´åˆ†æï¼ˆé«˜å³°æœŸï¼‰ï¼šä½¿ç”¨ `orders.created_at`
   - åº—é“ºè¥ä¸šé¢ï¼šä½¿ç”¨ `orders.store_id` + `orders.total_amount`
   - å¥—é¤é”€é‡ç»Ÿè®¡ï¼šä½¿ç”¨ `order_items.meal_id` + `order_items.quantity`
   - æ€»è¥ä¸šé¢ï¼šä½¿ç”¨ `orders.total_amount`
   - å ‚é£Ÿ/å¤–å–åˆ†ç±»ç»Ÿè®¡ï¼šä½¿ç”¨ `orders.order_type`
   - ä»˜æ¬¾æ–¹å¼ç»Ÿè®¡ï¼šä½¿ç”¨ `orders.payment_method_id`

## æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢è®¢å•é«˜å³°æœŸ
```sql
SELECT 
  strftime('%H', created_at) as hour,
  COUNT(*) as order_count
FROM orders
WHERE status = 'paid'
GROUP BY hour
ORDER BY order_count DESC;
```

### æŸ¥è¯¢åº—é“ºè¥ä¸šé¢
```sql
SELECT 
  store_id,
  COUNT(*) as order_count,
  SUM(total_amount) as total_revenue
FROM orders
WHERE status = 'paid'
GROUP BY store_id;
```

### æŸ¥è¯¢å¥—é¤é”€é‡
```sql
SELECT 
  m.name_zh,
  SUM(oi.quantity) as total_quantity,
  SUM(oi.subtotal) as total_revenue
FROM order_items oi
JOIN meals m ON oi.meal_id = m.id
JOIN orders o ON oi.order_id = o.id
WHERE o.status = 'paid'
GROUP BY m.id, m.name_zh
ORDER BY total_quantity DESC;
```

### æŸ¥è¯¢åº—é“ºè®¾ç½®
```sql
SELECT key, value, description, category
FROM settings
WHERE category = 'store';
```

### æŸ¥è¯¢äº‘ç«¯åŒæ­¥é…ç½®
```sql
SELECT key, value, description
FROM settings
WHERE category = 'sync';
```

### æŸ¥è¯¢ä»˜æ¬¾æ–¹å¼ç»Ÿè®¡
```sql
SELECT 
  pm.name_zh,
  COUNT(*) as order_count,
  SUM(o.total_amount) as total_revenue
FROM orders o
JOIN payment_methods pm ON o.payment_method_id = pm.id
WHERE o.status = 'paid'
GROUP BY pm.id, pm.name_zh
ORDER BY total_revenue DESC;
```

## äº‘ç«¯åŒæ­¥åŠŸèƒ½

ç³»ç»Ÿæ”¯æŒå°†æœ¬åœ°åº—é“ºæ•°æ®åŒæ­¥åˆ°äº‘ç«¯ç³»ç»Ÿï¼Œç”¨äºç”Ÿæˆè·¨åº—é“ºçš„è¥ä¸šæŠ¥å‘Šã€‚

### åŒæ­¥æ•°æ®å†…å®¹

1. **è®¢å•æ•°æ®**ï¼šæ‰€æœ‰å·²æ”¯ä»˜çš„è®¢å•ï¼ˆ`orders.status = 'paid'`ï¼‰
2. **è®¢å•æ˜ç»†**ï¼šè®¢å•ä¸­çš„æ‰€æœ‰å•†å“æ˜ç»†
3. **åº—é“ºä¿¡æ¯**ï¼šä» `settings` è¡¨è¯»å–åº—é“ºåŸºæœ¬ä¿¡æ¯

### åŒæ­¥æ—¶æœº

- å®šæ—¶åŒæ­¥ï¼šæ ¹æ® `settings.sync_interval` è®¾ç½®çš„é—´éš”è‡ªåŠ¨åŒæ­¥
- æ‰‹åŠ¨åŒæ­¥ï¼šå¯é€šè¿‡APIè§¦å‘ç«‹å³åŒæ­¥
- åŒæ­¥çŠ¶æ€ï¼šè®°å½•åœ¨ `settings.last_sync_time` ä¸­

### é…ç½®è¯´æ˜

åœ¨ `settings` è¡¨ä¸­é…ç½®ä»¥ä¸‹é¡¹ä»¥å¯ç”¨äº‘ç«¯åŒæ­¥ï¼š

- `sync_enabled`: è®¾ç½®ä¸º `true` å¯ç”¨åŒæ­¥
- `sync_url`: äº‘ç«¯ç³»ç»Ÿçš„APIåœ°å€ï¼ˆå¦‚ï¼š`https://cloud.example.com/api/sync`ï¼‰
- `sync_interval`: åŒæ­¥é—´éš”ï¼ˆåˆ†é’Ÿï¼Œå»ºè®®ï¼š60ï¼‰
- `sync_api_key`: äº‘ç«¯ç³»ç»Ÿåˆ†é…çš„APIå¯†é’¥ï¼ˆç”¨äºèº«ä»½éªŒè¯ï¼‰
